<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Indian Equity Markets</title>

  <!-- Classy, modern font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0c0f14;
      --panel: rgba(255,255,255,0.04);
      --panel-2: rgba(255,255,255,0.06);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --faint: rgba(255,255,255,0.50);
      --border: rgba(255,255,255,0.10);

      /* single tasteful accent */
      --accent: #a78bfa; /* soft violet */
      --accent-2: rgba(167,139,250,0.18);

      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 18px 45px rgba(0,0,0,0.35);
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.25);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a { color: inherit; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 36px 18px 60px;
    }

    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 18px;
      margin-bottom: 18px;
    }

    .brand {
      display: grid;
      gap: 8px;
    }

    .brand h1 {
      margin: 0;
      font-size: 22px;
      line-height: 1.2;
      letter-spacing: -0.02em;
      font-weight: 700;
    }

    .brand p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 68ch;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px var(--accent-2);
    }

    /* Minimal toolbar */
    .toolbar {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow-soft);
      margin-top: 10px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 220px auto auto;
      gap: 10px;
      align-items: center;
    }

    @media (max-width: 860px) {
      .row { grid-template-columns: 1fr; }
      .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    }

    input, select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      outline: none;
      font-size: 13px;
    }
    input::placeholder { color: rgba(255,255,255,0.45); }
    select option { color: #111; }

    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
      white-space: nowrap;
    }

    button:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.16);
    }
    button:active { transform: translateY(1px); }

    .btn-primary {
      background: rgba(167,139,250,0.14);
      border-color: rgba(167,139,250,0.35);
    }
    .btn-primary:hover {
      background: rgba(167,139,250,0.20);
      border-color: rgba(167,139,250,0.45);
    }

    .meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
    }

    /* Feed list */
    .list {
      margin-top: 18px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      background: rgba(255,255,255,0.02);
    }

    .item {
      padding: 16px 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: grid;
      gap: 8px;
    }
    .item:first-child { border-top: none; }

    .titlelink {
      font-weight: 650;
      letter-spacing: -0.01em;
      line-height: 1.3;
      font-size: 15px;
    }

    .summary {
      color: rgba(255,255,255,0.70);
      font-size: 13px;
      line-height: 1.45;
    }

    .subrow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .source {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: rgba(255,255,255,0.62);
      font-size: 12px;
    }

    .source::before{
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(255,255,255,0.28);
    }

    .time {
      color: rgba(255,255,255,0.50);
      font-size: 12px;
    }

    .empty {
      padding: 18px 16px;
      color: var(--muted);
      font-size: 13px;
    }

    .error {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(244,63,94,0.35);
      background: rgba(244,63,94,0.10);
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      display: none;
    }

    footer {
      margin-top: 16px;
      color: rgba(255,255,255,0.45);
      font-size: 11.5px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Indian Equity Markets</h1>
        <p>Minimal headline feed from NSE + curated sources. Filter by keyword or source. Auto-refresh every 2 minutes.</p>
      </div>

      <div class="status" title="API status">
        <span class="dot" id="apiDot"></span>
        <span id="apiText">Checking API…</span>
      </div>
    </header>

    <div class="toolbar">
      <div class="row">
        <input id="q" placeholder="Keyword (e.g., dividend, buyback, split, results, Reliance)" />
        <select id="src">
          <option value="">All sources</option>
        </select>

        <div class="actions" style="display:flex; gap:10px;">
          <button class="btn-primary" id="apply">Apply</button>
          <button id="reset">Reset</button>
        </div>
      </div>

      <div class="meta">
        <span class="pill" id="status">Loading…</span>
        <span class="pill">Tip: try “dividend”, “rights issue”, “earnings”, “IPO”</span>
      </div>
    </div>

    <div class="error" id="err"></div>

    <div class="list" id="list">
      <div class="empty">Loading…</div>
    </div>

    <footer>
      Data comes from public RSS feeds. Headlines may lag slightly depending on source updates.
    </footer>
  </div>

  <script>
    const qEl = document.getElementById("q");
    const srcEl = document.getElementById("src");
    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");
    const errEl = document.getElementById("err");
    const apiDot = document.getElementById("apiDot");
    const apiText = document.getElementById("apiText");

    function escapeHtml(s) {
      return (s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function setQueryFromURL() {
      const p = new URLSearchParams(location.search);
      qEl.value = p.get("q") || "";
      srcEl.value = p.get("src") || "";
    }

    function updateURL() {
      const p = new URLSearchParams();
      if (qEl.value.trim()) p.set("q", qEl.value.trim());
      if (srcEl.value.trim()) p.set("src", srcEl.value.trim());
      const qs = p.toString();
      history.replaceState({}, "", qs ? `${location.pathname}?${qs}` : `${location.pathname}`);
    }

    async function loadSourcesIfNeeded(sources) {
      if (!sources || !sources.length) return;
      const current = srcEl.value;
      const existing = new Set([...srcEl.options].map(o => o.value));
      sources.forEach(s => {
        if (!existing.has(s)) {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          srcEl.appendChild(opt);
        }
      });
      srcEl.value = current;
    }

    function showError(msg) {
      errEl.style.display = "block";
      errEl.textContent = msg;
    }

    function clearError() {
      errEl.style.display = "none";
      errEl.textContent = "";
    }

    function render(items) {
      if (!items || items.length === 0) {
        listEl.innerHTML = `<div class="empty">No items found. Try clearing filters or waiting for refresh.</div>`;
        return;
      }

      listEl.innerHTML = items.map(i => `
        <div class="item">
          <a class="titlelink" href="${escapeHtml(i.link)}" target="_blank" rel="noopener noreferrer">
            ${escapeHtml(i.title)}
          </a>
          ${i.summary ? `<div class="summary">${escapeHtml(i.summary)}</div>` : ""}
          <div class="subrow">
            <div class="source">${escapeHtml(i.source)}</div>
            <div class="time">${i.published ? escapeHtml(i.published) : ""}</div>
          </div>
        </div>
      `).join("");
    }

    async function checkApi() {
      try {
        const res = await fetch("/api/health", { cache: "no-store" });
        if (!res.ok) throw new Error("health not ok");
        apiDot.style.background = "var(--accent)";
        apiDot.style.boxShadow = "0 0 0 6px var(--accent-2)";
        apiText.textContent = "API healthy";
      } catch (e) {
        apiDot.style.background = "rgba(244,63,94,0.95)";
        apiDot.style.boxShadow = "0 0 0 6px rgba(244,63,94,0.15)";
        apiText.textContent = "API unreachable";
      }
    }

    async function fetchNews() {
      updateURL();
      clearError();

      const p = new URLSearchParams();
      if (qEl.value.trim()) p.set("q", qEl.value.trim());
      if (srcEl.value.trim()) p.set("src", srcEl.value.trim());

      statusEl.textContent = "Fetching…";
      listEl.innerHTML = `<div class="empty">Fetching latest headlines…</div>`;

      try {
        const res = await fetch(`/api/news?${p.toString()}`, { cache: "no-store" });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`API ${res.status}: ${text.slice(0, 400)}`);
        }

        const data = await res.json();
        await loadSourcesIfNeeded(data.sources);
        statusEl.textContent = `${data.count} items • Updated: ${data.generated_at}`;
        render(data.items);
      } catch (e) {
        statusEl.textContent = "Failed to load";
        showError(String(e));
        render([]);
      }
    }

    document.getElementById("apply").addEventListener("click", () => {
      fetchNews();
    });

    document.getElementById("reset").addEventListener("click", () => {
      qEl.value = "";
      srcEl.value = "";
      fetchNews();
    });

    // init
    setQueryFromURL();
    checkApi();
    fetchNews();

    // auto refresh every 2 minutes
    setInterval(() => {
      checkApi();
      fetchNews();
    }, 120000);
  </script>
</body>
</html>
